services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  zookeeper:
    image: zookeeper:3.9
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181
    volumes:
      - zk-data:/data
      - zk-datalog:/datalog
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 5s
      timeout: 3s
      retries: 5

  zoonavigator:
    image: elkozmon/zoonavigator:latest
    ports:
      - "9000:9000"
    environment:
      HTTP_PORT: 9000
      AUTO_CONNECT_CONNECTION_STRING: zookeeper:2181
    depends_on:
      zookeeper:
        condition: service_healthy

  zk-init:
    image: zookeeper:3.9
    depends_on:
      zookeeper:
        condition: service_healthy
    volumes:
      - ./config/init-rules.json:/init-rules.json
    entrypoint: >
      /bin/bash -c "
        echo 'Waiting for ZooKeeper...' &&
        sleep 3 &&
        /apache-zookeeper-3.9.2-bin/bin/zkCli.sh -server zookeeper:2181 create /rate-limiter '' 2>/dev/null;
        /apache-zookeeper-3.9.2-bin/bin/zkCli.sh -server zookeeper:2181 create /rate-limiter/rules \"$$(cat /init-rules.json)\" 2>/dev/null;
        echo 'ZooKeeper initialized with rate limit rules'
      "

  test-api-service:
    build:
      context: ./test-api-service
    ports:
      - "9090:9090"
    environment:
      API_PORT: 9090
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  rate-limiter-1:
    build:
      context: ./rate-limiter-gateway
    ports:
      - "8081:8080"
    environment:
      GATEWAY_PORT: 8080
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ZOOKEEPER_CONNECT_STRING: zookeeper:2181
      API_SERVICE_URL: http://test-api-service:9090
    depends_on:
      redis:
        condition: service_healthy
      zookeeper:
        condition: service_healthy
      zk-init:
        condition: service_completed_successfully
      test-api-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  rate-limiter-2:
    build:
      context: ./rate-limiter-gateway
    ports:
      - "8082:8080"
    environment:
      GATEWAY_PORT: 8080
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ZOOKEEPER_CONNECT_STRING: zookeeper:2181
      API_SERVICE_URL: http://test-api-service:9090
    depends_on:
      redis:
        condition: service_healthy
      zookeeper:
        condition: service_healthy
      zk-init:
        condition: service_completed_successfully
      test-api-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:v2.53.0
    ports:
      - "9091:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    depends_on:
      - rate-limiter-1
      - rate-limiter-2

  grafana:
    image: grafana/grafana:11.1.0
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

  test-client:
    build:
      context: ./test-client
    environment:
      GATEWAY_URL: http://rate-limiter-1:8080
      TEST_REQUESTS: 30
      TEST_CONCURRENT: 5
      TEST_ENDPOINT: /api/resource
      TEST_DELAY_MS: 100
    depends_on:
      rate-limiter-1:
        condition: service_healthy
    profiles:
      - test

volumes:
  redis-data:
  zk-data:
  zk-datalog:
  prometheus-data:
  grafana-data:
